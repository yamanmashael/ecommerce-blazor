@page "/photos/{productItemId:int}"
@page "/photos/{productItemId:int}/{ProductId:int}"

@attribute [Authorize(Roles = "Admin")]

@layout AdminLayout

@using Blazor.Data
@using Blazor.Services
@inject NavigationManager NavManager
@inject ProductImageService ImageService

<style>
    .image-container {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
</style>

<h3>Product Photos</h3>

@if (images == null)
{
    <div class="alert alert-info" role="alert">
        <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        Loading images...
    </div>
}
else
{
    <h5>Product Item ID: @productItemId</h5>

    <div class="mb-3 d-flex align-items-center">
        <InputFile OnChange="HandleSelected" class="form-control me-2" />
        <button class="btn btn-success" @onclick="UploadImage" disabled="@(!canUpload)">
            <i class="bi bi-upload"></i> Add Image
        </button>
    </div>

    @if (images.Any())
    {
        <div class="row g-3">
            @foreach (var img in images)
            {
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="image-container">
                        <img src="@img.ImageUrl" alt="Product Image" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;" />
                        <br />
                        <button class="btn btn-danger btn-sm mt-2" @onclick="() => DeleteImage(img.Id)">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-warning" role="alert">
            No images found for this product. 😟
        </div>
    }

    <a href="/productitem/@ProductId" class="btn btn-secondary mb-4">Back to Product Item</a>
}

@code {
    [Parameter] public int productItemId { get; set; }
    [Parameter] public int ProductId { get; set; }

    private List<ProductImageDto> images;
    private IBrowserFile selectedFile;
    private bool canUpload => selectedFile != null;

    protected override async Task OnInitializedAsync()
    {
        await LoadImages();
    }

    private async Task LoadImages()
    {
        images = await ImageService.GetImagesByProductItemIdAsync(productItemId);
    }

    private void HandleSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    private async Task UploadImage()
    {
        if (selectedFile == null) return;

        var dto = new ProductImageCreateDto
            {
                ProductItemId = productItemId,
                ImageFile = selectedFile
            };

        var success = await ImageService.AddImageAsync(dto);
        if (success)
        {
            await LoadImages();
            selectedFile = null;
            StateHasChanged();
        }
    }

    private async Task DeleteImage(int id)
    {
        var success = await ImageService.DeleteImageAsync(id);
        if (success)
        {
            await LoadImages();
            StateHasChanged();
        }
    }
}
