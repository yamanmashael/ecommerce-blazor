@page "/dashboard"
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout

@using Blazor.Data
@using Blazor.Services
@inject Blazor.Services.DashboardService DashboardService

<h3 class="mb-4">Dashboard 📊</h3>

<style>
    .dashboard-card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
    }

        .dashboard-card .card-body {
            padding: 1.3rem 1.4rem;
        }

    .card-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        opacity: 0.9;
    }

    .card-value {
        font-size: 2rem;
        font-weight: 700;
    }

    .card-subtext {
        font-size: 0.8rem;
        opacity: 0.85;
    }

    .card-icon {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
    }

</style>

<div class="row g-3 mb-4">
    <!-- New Customers -->
    <div class="col-12 col-md-6">
        <div class="card dashboard-card bg-primary text-white h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <p class="card-label mb-1">New Customers</p>
                    <h2 class="card-value mb-0">@_customerCount</h2>
                    <small class="card-subtext">Last 30 days</small>
                </div>
                <div class="card-icon">
                    <i class="bi bi-people-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Count -->
    <div class="col-12 col-md-6">
        <div class="card dashboard-card bg-success text-white h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <p class="card-label mb-1">Orders Count</p>
                    <h2 class="card-value mb-0">@TotalOrders</h2>
                    <small class="card-subtext">All statuses</small>
                </div>
                <div class="card-icon">
                    <i class="bi bi-bag-check-fill"></i>
                </div>
            </div>
        </div>
    </div>
</div>


<hr class="my-4" />

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow p-3">
            <h3>📈 Sales & Orders Summary</h3>

            <select class="form-select form-select-sm d-inline-block w-auto mb-3" @onchange="OnPeriodChange">
                <option value="daily">Daily</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
            </select>

            <div class="chart-scroll-container">
                @if (salesData == null)
                {
                    <p>Loading data...</p>
                }
                else if (!salesData.Any())
                {
                    <p>No data available.</p>
                }
                else
                {
                    <div class="chart">
                        @foreach (var item in salesData)
                        {
                            <div class="bar"
                                 style="height:@((item.OrdersCount * 100) / maxOrders)%"
                                 title="@($"{item.Period}: {item.OrdersCount} orders, {item.TotalSales.ToString("C")}")">
                                <span>@item.OrdersCount</span>
                            </div>
                        }
                    </div>
                    <div class="labels">
                        @foreach (var item in salesData)
                        {
                            <span>@item.Period</span>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<hr class="my-4" />

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow p-3 h-100">
            <h3>📊 Orders Statistics by Status</h3>
            <div class="pie-container d-flex justify-content-center align-items-center flex-wrap">
                <div class="pie-chart" style="@PieStyle"></div>

                <ul class="legend list-unstyled me-4">
                    @foreach (var item in _orderStatusData)
                    {
                        <li>
                            <span class="color-box me-1" style="background:@GetColor(item.StatusName)"></span>
                            @item.StatusName: <strong>@item.OrderStatusCount</strong>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow p-3 h-100">
            <h3>🌟 Top Selling Products</h3>
            @if (products == null)
            {
                <p>Loading...</p>
            }
            else if (!products.Any())
            {
                <p>No products available.</p>
            }
            else
            {
                <ul class="list-group small-dashboard-list">
                    @foreach (var p in products)
                    {
                        <li class="list-group-item d-flex align-items-center">
                            <img src="@p.ImageUrl"
                                 alt="@p.ProductName"
                                 width="50"
                                 height="50"
                                 class="me-3 rounded" />
                            <div class="flex-fill">
                                <strong>@p.ProductName</strong><br />
                                <small>
                                    Quantity: <strong>@p.TotalQuantity</strong> |
                                    Sales: <strong>@p.TotalPrice.ToString("C")</strong>
                                </small>
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
</div>

@code {
    private int _customerCount;
    private List<ProductDahboardDto>? products;
    private List<SalesSummaryDto> salesData = new();
    private string selectedPeriod = "daily";
    private int maxOrders = 1;
    private List<OrderStatusDashboardDto> _orderStatusData = new();
    private string PieStyle = "";

    // مجموع كل الطلبات بكل الحالات
    private int TotalOrders => _orderStatusData?.Sum(o => o.OrderStatusCount) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        _customerCount = await DashboardService.NewCustomersCountAsync();
        products = await DashboardService.GetPopularProductsAsync();

        _orderStatusData = await DashboardService.GetOrderStatus();
        BuildPieStyle();

        await LoadData();
    }

    private async Task OnPeriodChange(ChangeEventArgs e)
    {
        selectedPeriod = e.Value?.ToString() ?? "daily";
        await LoadData();
    }

    private async Task LoadData()
    {
        DateTime startDate = selectedPeriod switch
        {
            "daily" => DateTime.UtcNow.AddDays(-7),
            "monthly" => new DateTime(DateTime.UtcNow.Year, 1, 1),
            "yearly" => DateTime.UtcNow.AddYears(-5),
            _ => DateTime.UtcNow.AddDays(-7)
        };

        salesData = await DashboardService.GetSalesAsync(selectedPeriod, startDate);

        if (salesData.Any())
            maxOrders = salesData.Max(x => x.OrdersCount);
        else
            maxOrders = 1;
    }

    private void BuildPieStyle()
    {
        var total = _orderStatusData.Sum(o => o.OrderStatusCount);
        if (total == 0)
        {
            PieStyle = "background: #e5e7eb;"; // لو ما في بيانات
            return;
        }

        double start = 0;
        List<string> slices = new();

        foreach (var item in _orderStatusData)
        {
            var percent = (double)item.OrderStatusCount / total * 100;
            var end = start + percent;
            slices.Add($"{GetColor(item.StatusName)} {start}% {end}%");
            start = end;
        }

        PieStyle = $"background: conic-gradient({string.Join(",", slices)});";
    }

    private string GetColor(string status) =>
        status switch
        {
            "Canceled" => "#FF6384",
            "Completed" => "#36A2EB",
            "Pending" => "#FFCE56",
            "Processing" => "#4CAF50",
            "Returned" => "#FF9800",
            "Shipped" => "#9C27B0",
            _ => "#999999"
        };
}
